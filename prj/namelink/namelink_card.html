<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NAME LINK Card Maker</title>

  <!-- iOS(ì•„ì´í°/ì•„ì´íŒ¨ë“œ) + Mac Safari ê°ì§€ -->
  <script>
    (function () {
  var ua = navigator.userAgent || navigator.vendor || window.opera;

  // iOS (iPhone / iPad / iPod)
  var isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;

  // ë§¥ ì „ì²´ (ë¸Œë¼ìš°ì € ê°€ë¦¬ì§€ ì•Šê³ )
  var isMac = /Macintosh|Mac OS X/.test(ua);

  // iOS + Mac ì´ë©´ ì „ë¶€ ë³´ì • í´ë˜ìŠ¤ ì ìš©
  if (isIOS || isMac) {
    document.documentElement.classList.add('is-ios');
  }
})();

  </script>

  <!-- DOM -> ì´ë¯¸ì§€ ìº¡ì³ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <!-- GIF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

  <style>
    :root{
      --page-bg:#020617;
      --panel-bg:#020617;
      --panel-border:rgba(148,163,184,.35);
      --panel-radius:18px;
      --panel-shadow:0 18px 50px rgba(15,23,42,.7);

      /* default rank: S (ë„¤ì˜¨ ì¹´ë“œ ìƒ‰ ì¡°í•© ìœ ì§€) */
      --rankBorder1:#f8fb12;
      --rankBorder2:#ff4da5;
      --rankBorder3:#1fe8ff;
      --rankColor:#fbbf24;
      --rankColorSoft:#fef3c7;
      --dangerBg:#fef3c7;
      --dangerText:#92400e;

      --exportScale:1;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo",
      "Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;
      color:#2a2a2a;
    }

    .page{
      max-width:1100px;
      margin:24px auto 40px;
      padding:0 16px 32px;
    }

    h1{
      margin:8px 0 4px;
      font-size:24px;
      font-weight:800;
      letter-spacing:0.03em;
    }

    .subtitle{
      font-size:12px;
      color:#9ca3af;
      margin-bottom:18px;
    }

    .layout{
      display:flex;
      flex-wrap:wrap;
      gap:20px;
      align-items:flex-start;
    }

    .controls{
      flex:1 1 280px;
      min-width:260px;
      background:rgba(15,23,42,.92);
      border-radius:var(--panel-radius);
      border:1px solid var(--panel-border);
      box-shadow:var(--panel-shadow);
      padding:16px 16px 18px;
    }

    .controls h2{
      font-size:14px;
      margin:0 0 8px;
      font-weight:700;
    }

    .form-group{
      margin-bottom:10px;
      font-size:11px;
    }

    .form-group label{
      display:block;
      margin-bottom:4px;
      color:#cbd5f5;
      font-weight:600;
    }

    .form-row{
      display:flex;
      gap:6px;
    }

    .form-row > *{
      flex:1;
    }

    input[type="text"],
    select{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid rgba(148,163,184,.5);
      background:#020617;
      color:#e5e7eb;
      font-size:11px;
      outline:none;
    }
    input[type="text"] {
      font-size: 16px !important;
    }
    input[type="file"]{
      width:100%;
      font-size:11px;
    }

    input[type="text"]:focus,
    select:focus{
      border-color:#7c3aed;
      box-shadow:0 0 0 1px rgba(124,58,237,.5);
    }

    .hint{
      font-size:10px;
      color:#9ca3af;
      margin-top:2px;
    }

    .scale-row{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .scale-row span{
      font-size:10px;
      color:#9ca3af;
      white-space:nowrap;
    }

    input[type="range"]{
      flex:1;
    }

    .preview{
      flex:1.2 1 320px;
      min-width:340px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }

    .btn-save{
      border:none;
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      background:linear-gradient(135deg,#4f46e5,#ec4899);
      color:#f9fafb;
      box-shadow:0 3px 8px rgba(0,0,0,.4);
      white-space:nowrap;
    }

    .btn-save:nth-child(2){
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
    }

    .btn-save:active{
      transform:translateY(1px);
      box-shadow:0 1px 4px rgba(0,0,0,.5);
    }

    /* ===== CARD ===== */

    .card-wrapper{
      flex:1 1 320px;
      min-width:260px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }

    /* ë¹„ìœ¨ ìœ ì§€: padding-bottom íŠ¸ë¦­ ì‚¬ìš© */
    .card-border{
      width:100%;
      max-width:380px;
      border-radius:22px;
      background:linear-gradient(135deg,var(--rankBorder1),var(--rankBorder2),var(--rankBorder3));
      box-sizing:border-box;
      box-shadow:0 12px 28px rgba(15,23,42,0.75);
      position:relative;
      overflow:hidden;
    }

    .card-border::before{
      content:"";
      display:block;
      /* 7:11 ë¹„ìœ¨ â†’ (ë†’ì´/ë„ˆë¹„)*100% */
      padding-bottom:calc(11 / 7 * 100%);
    }

    /* ë„¤ì˜¨ í…Œë‘ë¦¬ ìœ„ì— ì–¹íˆëŠ” ë…¸ì´ì¦ˆ */
    .card-border-noise{
      position:absolute;
      inset:0;
      border-radius:22px;
      background-image:
        repeating-linear-gradient(135deg,
          rgba(255,255,255,1) 0,
          rgba(255,255,255,1) 2px,
          transparent 2px,
          transparent 4px),
        repeating-linear-gradient(45deg,
          rgba(0,0,0,.7) 0,
          rgba(0,0,0,.7) 1.5px,
          transparent 1.5px,
          transparent 3px);
      mix-blend-mode:overlay;
      pointer-events:none;
      opacity:0.2;
      z-index:1;
      animation:noiseMove 0.6s steps(3) infinite;
    }

    @keyframes noiseMove{
      0%{transform:translate3d(0,0,0);}
      25%{transform:translate3d(6px,-4px,0);}
      50%{transform:translate3d(-5px,3px,0);}
      75%{transform:translate3d(3px,-6px,0);}
      100%{transform:translate3d(0,0,0);}
    }

    .card-inner{
      position:absolute;
      inset:6px;
      border-radius:18px;
      background:radial-gradient(circle at top,#1f2937 0,#020617 55%,#020617 100%);
      padding:10px 10px 12px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      overflow:hidden;
      width:calc(100% - 12px);
      height:calc(100% - 12px);
      z-index:2;
    }

    .card-rank-row{
      display:flex;
      justify-content:flex-end;
    }

    .card-rank-label{
      padding:2px 7px;
      border-radius:8px;
      color:var(--rankColor);
      font-size:calc(26px * var(--exportScale));
      font-weight:800;
      letter-spacing:.5px;
      text-shadow:-1px 0 #fff, 1px 0 #000, 0 1px #000, 0 -1px #000,
      0 0 6px rgba(251,191,36,0.9);
      font-family:Impact, system-ui, sans-serif;
    }

    .card-image-area{
      margin-top:10px;
      border-radius:14px;
      background:url('https://cdn.caveduck.io/cdn-cgi/image/dpr=2,f=auto,w=500/charim/e0ced288-81ac-4ee3-a37b-577499e416f2?v=17652048340000') no-repeat bottom center/cover;
      padding:10px 6px 8px;
      box-sizing:border-box;
      display:flex;
      justify-content:center;
      align-items:center;
      position:relative;
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
    }

    .card-char-wrap{
      position:absolute;
      inset:0;
      margin:0;
      width:100%;
      height:100%;
      display:flex;
      justify-content:center;
      align-items:flex-end;
      border-radius:12px;
      overflow:hidden;
      background:transparent;
      pointer-events:none;
    }

    .card-char-inner{
      position:absolute;
      bottom:0;
      left:50%;
      /* ê¸°ë³¸: ì¹´ë“œ í•˜ë‹¨ ì¤‘ì•™ì— ì„œ ìˆëŠ” ìƒíƒœ */
      transform:translate(-50%, 0) scale(0.8);
      transform-origin:50% 100%;
    }

    .card-char-img{
      display:block;
      height:130%;
      width:auto;
      pointer-events:none;
      image-rendering:auto;
    }

    /* ê³µí†µ ê¸°ë³¸ ë°°ì§€ ìŠ¤íƒ€ì¼ (ëª¨ë“  ë¸Œë¼ìš°ì € ê³µí†µ) */
    .badge-role-name{
      position:absolute;
      top:8px;
      left:10px;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(15,23,42,0.85);
      border:1px solid rgba(148,163,184,0.7);
      font-size:calc(9px * var(--exportScale));
      color:#e5e7eb;
      font-weight:700;
      letter-spacing:.5px;
      z-index:3;

      display:inline-flex;
      align-items:center;
      justify-content:center;
      line-height:1;
    }

    .card-emoji{
      position:absolute;
      font-size:calc(30px * var(--exportScale));
      animation:tada 2s infinite;
      z-index:3;
    }

    .card-emoji-1{ top:14%; right:10%; }
    .card-emoji-2{ top:52%; left:8%; }
    .card-emoji-3{ bottom:9%; right:16%; }

    @keyframes tada{
      0%{transform:scale(1);}
      10%,20%{transform:scale(.9) rotate(-3deg);}
      30%,50%,70%,90%{transform:scale(1.1) rotate(3deg);}
      40%,60%,80%{transform:scale(1.1) rotate(-3deg);}
      100%{transform:scale(1);}
    }

    .card-footer{
      margin-top:8px;
      border-radius:12px;
      background:linear-gradient(90deg,#0f172a,#020617);
      padding:6px 8px 7px;
      box-sizing:border-box;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 -1px 0 rgba(148,163,184,0.4),
                 0 6px 10px rgba(0,0,0,0.7);
      gap:8px;
    }

    .card-names{
      min-width:0;
    }

    .name-ko{
      margin:0;
      font-size:calc(19px * var(--exportScale));
      font-weight:900;
      color:var(--rankColorSoft);
      text-shadow:-1px 0 #000,1px 0 #000,0 1px #000,0 -1px #000,
      0 0 6px rgba(251,191,36,0.8);
      letter-spacing:1px;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
      max-width:160px;
    }

    .name-extra{
      margin:1px 0 0;
      font-size:calc(10px * var(--exportScale));
      color:#9ca3af;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
      max-width:180px;
    }

    .card-badges{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      font-size:9px;
      gap:3px;
    }

    /* ê³µí†µ ê¸°ë³¸ pill ìŠ¤íƒ€ì¼ (ëª¨ë“  ë¸Œë¼ìš°ì € ê³µí†µ) */
    .pill{
      padding:4px 9px;
      border-radius:999px;
      font-weight:800;
      letter-spacing:.5px;
      white-space:nowrap;
      font-size:calc(9px * var(--exportScale));

      display:inline-flex;
      align-items:center;
      justify-content:center;
      line-height:1;
    }

    .role-pill{
      background:#eef2ff;
      color:#3730a3;
    }

    .danger-pill{
      background:var(--dangerBg);
      color:var(--dangerText);
    }

    .card-bottom-text{
      margin-top:5px;
      text-align:right;
      font-size:calc(8px * var(--exportScale));
      color:#9ca3af;
      letter-spacing:1px;
      text-transform:uppercase;
    }

    /* ===== RANK THEME ===== */

    .rank-SS{
      --rankBorder1:#ec0606;
      --rankBorder2:#fb5a3c;
      --rankBorder3:#ffd37a;
      --rankColor:#da0505;
      --rankColorSoft:#ffe4e0;
      --dangerBg:#fee2e2;
      --dangerText:#b91c1c;
      --nameColor:#ffe4e0;
    }

    .rank-S{
      --rankBorder1:#fbc112;
      --rankBorder2:#fff64d;
      --rankBorder3:#ffe6a7;
      --rankColor:#fbbf24;
      --rankColorSoft:#fef3c7;
      --dangerBg:#fee2e2;
      --dangerText:#92400e;
      --nameColor:#fef3c7;
    }

    .rank-A{
      --rankBorder1:#8b5cf6;
      --rankBorder2:#a855f7;
      --rankBorder3:#c4b5fd;
      --rankColor:#e9d5ff;
      --rankColorSoft:#f5ebff;
      --dangerBg:#f5ebff;
      --dangerText:#6b21a8;
      --nameColor:#f5ebff;
    }
    .rank-A .card-rank-label {
      text-shadow: -1px 0 #363636, 1px 0 #000, 0 1px #000, 0 -1px #000, 0 0 6px rgb(115 87 17 / 90%);
    }

    .rank-B{
      --rankBorder1:#2563eb;
      --rankBorder2:#3b82f6;
      --rankBorder3:#93c5fd;
      --rankColor:#bfdbfe;
      --rankColorSoft:#e0f2fe;
      --dangerBg:#e0f2fe;
      --dangerText:#1d4ed8;
      --nameColor:#e0f2fe;
    }
    .rank-B .card-rank-label {
      text-shadow: -1px 0 #363636, 1px 0 #000, 0 1px #000, 0 -1px #000, 0 0 6px rgb(115 87 17 / 90%);
    }

    .rank-C{
      --rankBorder1:#16a34a;
      --rankBorder2:#22c55e;
      --rankBorder3:#86efac;
      --rankColor:#bbf7d0;
      --rankColorSoft:#dcfce7;
      --dangerBg:#dcfce7;
      --dangerText:#166534;
      --nameColor:#dcfce7;
    }
    .rank-C .card-rank-label {
      text-shadow: -1px 0 #363636, 1px 0 #000, 0 1px #000, 0 -1px #000, 0 0 6px rgb(115 87 17 / 90%);
    }

    .rank-D{
      --rankBorder1:#cbd9f6;
      --rankBorder2:#f3f4f6;
      --rankBorder3:#9bbef4;
      --rankColor:#e5e7eb;
      --rankColorSoft:#ffffff;
      --dangerBg:#f9fafb;
      --dangerText:#1f2937;
      --nameColor:#ffffff;
    }
    .rank-D .card-rank-label {
      text-shadow: -1px 0 #363636, 1px 0 #000, 0 1px #000, 0 -1px #000, 0 0 6px rgb(115 87 17 / 90%);
    }

    .rank-F{
      --rankBorder1:#111827;
      --rankBorder2:#4b5563;
      --rankBorder3:#9ca3af;
      --rankColor:#d1d5db;
      --rankColorSoft:#e5e7eb;
      --dangerBg:#e5e7eb;
      --dangerText:#111827;
      --nameColor:#e5e7eb;
    }
    .rank-F .card-rank-label {
      text-shadow: -1px 0 #363636, 1px 0 #000, 0 1px #000, 0 -1px #000, 0 0 6px rgb(115 87 17 / 90%);
    }

    /* ========================= */
    /*   iOS + Mac Safari ë³´ì •   */
    /* ========================= */
    .is-ios .pill{
      padding:2px 9px 4px;   /* ìœ„ ì‚´ì§ ì¤„ì´ê³  ì•„ë˜ ëŠ˜ë ¤ì„œ ê¸€ì ì‹œê°ì  ì¤‘ì•™ â†‘ */
    }

    .is-ios .badge-role-name{
      padding:2px 8px 4px;
    }

    @media (max-width:768px){
      .layout{
        flex-direction:column;
        justify-content: center;
        align-items: center;
      }
      .preview{
        order:-1;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <h1>NAME LINK Card Maker </h1>
  <div class="subtitle">by. ğ• @Olli_mine</div>

  <div class="layout">
    <!-- PREVIEW -->
    <section class="preview">
      <div class="card-wrapper rank-S" id="cardWrapper">
        <div class="card-border" id="cardBorder">
          <div class="card-border-noise"></div>
          <div class="card-inner">
            <div class="card-rank-row">
              <div class="card-rank-label" id="rankLabel">S Rank</div>
            </div>

            <div class="card-image-area" id="imageArea">
              <div class="badge-role-name" id="roleBadge">HERO : TASER</div>

              <!-- ìºë¦­í„° ì´ë¯¸ì§€ (IMG ë²„ì „) -->
              <div class="card-char-wrap">
                <div class="card-char-inner" id="charInner">
                  <img
                    id="charImg"
                    class="card-char-img"
                    src="./src/image.png"
                    alt="character">
                </div>
              </div>

              <div class="card-emoji card-emoji-1" id="emojiSlot1">ğŸ’¦</div>
              <div class="card-emoji card-emoji-2" id="emojiSlot2">ğŸ¬</div>
              <div class="card-emoji card-emoji-3" id="emojiSlot3">ğŸ </div>
            </div>

            <div class="card-footer">
              <div class="card-names">
                <p class="name-ko" id="nameKoLabel">í…Œì´ì €</p>
                <p class="name-extra" id="nameSub">Taser Â· Sê¸‰ ì´ˆëŠ¥ë ¥ ë³´ìœ  íˆì–´ë¡œ</p>
              </div>
              <div class="card-badges">
                <span class="pill role-pill" id="rolePill">ROLE Â· HERO</span>
                <span class="pill danger-pill" id="dangerPill">DANGER Â· S</span>
              </div>
            </div>

            <div class="card-bottom-text">
              <span>NAME LINK</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTROLS -->
    <section class="controls">
      <h2>ì„¸íŒ…</h2>

      <div class="form-group">
        <label for="imageInput">1. ìºë¦­í„° ì´ë¯¸ì§€</label>
        <input type="file" id="imageInput" accept="image/png,image/*">
        <div class="hint">í°ìƒ‰ ë°°ê²½ì˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œ í•˜ë©´ ìë™ìœ¼ë¡œ ë°°ê²½ì´ ì§€ì›Œì§€ì§€ë§Œ, ì§ì ‘ ë°°ê²½ì„ ì§€ìš´ png ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì‹œëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>
      </div>

      <div class="form-group">
        <label>2. ì´ë¦„</label>
        <div class="form-row">
          <input type="text" id="nameKo" placeholder="í•œê¸€ ì´ë¦„">
          <input type="text" id="nameEn" placeholder="ì˜ë¬¸ ì´ë¦„">
        </div>
      </div>

      <div class="form-group">
        <label>3. ë¡¤ & ë“±ê¸‰</label>
        <div class="form-row">
          <select id="roleSelect">
            <option value="hero" selected>íˆì–´ë¡œ (HERO)</option>
            <option value="villain">ë¹ŒëŸ° (VILLAIN)</option>
            <option value="normal">ë…¸ë§ (NORMAL)</option>
          </select>
          <select id="rankSelect">
            <option value="SS">SS</option>
            <option value="S" selected>S</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="F">F</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>4. ì¹´ë“œ ì´ëª¨ì§€ 3ê°œ</label>
        <div class="form-row">
          <input type="text" id="emoji1" value="ğŸ’¦">
          <input type="text" id="emoji2" value="ğŸ¬">
          <input type="text" id="emoji3" value="ğŸ ">
        </div>
      </div>

      <div class="form-group">
        <label>5. ì´ë¯¸ì§€ í¬ê¸° ì¡°ì ˆ</label>
        <div class="scale-row">
          <span>ì‘ê²Œ</span>
          <input type="range" id="scaleRange" min="0.3" max="1.3" step="0.02" value="0.42">
          <span>í¬ê²Œ</span>
        </div>
      </div>

      <div class="form-group">
        <label>6. ì´ë¯¸ì§€ ìœ„ì¹˜ ì¡°ì ˆ</label>
        <div class="scale-row">
          <span>ì¢Œ</span>
          <input type="range" id="offsetXRange" min="-100" max="100" value="-20">
          <span>ìš°</span>
        </div>
        <div class="scale-row" style="margin-top:4px;">
          <span>ìƒ</span>
          <input type="range" id="offsetYRange" min="-100" max="100" value="-10">
          <span>í•˜</span>
        </div>
      </div>

      <div class="form-group">
        <label>7. ì¹´ë“œ ì €ì¥</label>
        <div class="form-row">
          <button type="button" id="saveJpgBtn" class="btn-save">ì €ì¥</button>
          <button type="button" id="saveGifBtn" class="btn-save" style="display: none;">GIF ì €ì¥(ì›€ì§¤)</button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  const imageInput = document.getElementById('imageInput');
  const cardWrapper = document.getElementById('cardWrapper');
  const cardBorder = document.getElementById('cardBorder');
  const charInner = document.getElementById('charInner');
  const charImg = document.getElementById('charImg');

  const nameKoInput = document.getElementById('nameKo');
  const nameEnInput = document.getElementById('nameEn');
  const roleSelect = document.getElementById('roleSelect');
  const rankSelect = document.getElementById('rankSelect');

  const emoji1Input = document.getElementById('emoji1');
  const emoji2Input = document.getElementById('emoji2');
  const emoji3Input = document.getElementById('emoji3');

  const rankLabel = document.getElementById('rankLabel');
  const roleBadge = document.getElementById('roleBadge');
  const nameKoLabel = document.getElementById('nameKoLabel');
  const nameSub = document.getElementById('nameSub');
  const rolePill = document.getElementById('rolePill');
  const dangerPill = document.getElementById('dangerPill');

  const emojiSlot1 = document.getElementById('emojiSlot1');
  const emojiSlot2 = document.getElementById('emojiSlot2');
  const emojiSlot3 = document.getElementById('emojiSlot3');

  const scaleRange = document.getElementById('scaleRange');
  const offsetXRange = document.getElementById('offsetXRange');
  const offsetYRange = document.getElementById('offsetYRange');

  const saveJpgBtn = document.getElementById('saveJpgBtn');
  const saveGifBtn = document.getElementById('saveGifBtn');

  const rankClasses = ['rank-SS','rank-S','rank-A','rank-B','rank-C','rank-D','rank-F'];

  const roleKorMap = {
    hero:'íˆì–´ë¡œ',
    villain:'ë¹ŒëŸ°',
    normal:'ë…¸ë§'
  };

  const roleEngMap = {
    hero:'HERO',
    villain:'VILLAIN',
    normal:'NORMAL'
  };

  // ===== ìœ„ì¹˜/í¬ê¸° ìƒíƒœê°’ =====
  let currentScale = parseFloat(scaleRange.value);
  let currentOffsetX = parseFloat(offsetXRange.value); // px
  let currentOffsetY = parseFloat(offsetYRange.value); // px

  function updateCharTransform() {
    charInner.style.transform =
      `translate(calc(-50% + ${currentOffsetX}px), ${currentOffsetY}px) scale(${currentScale})`;
  }

  // ì´ˆê¸° transform ì„¸íŒ…
  updateCharTransform();

  // ===== ë°°ê²½ ì œê±° + IMG srcë¡œ ë„£ê¸° =====
  imageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];

          const isAlmostWhite = (r > 240 && g > 240 && b > 240);
          const isGreenScreen = (g > 120 && g > r + 30 && g > b + 30);

          if (isAlmostWhite || isGreenScreen) {
            data[i + 3] = 0;
          }
        }

        ctx.putImageData(imageData, 0, 0);
        const url = canvas.toDataURL('image/png');
        charImg.src = url;
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });

  // ===== ì¹´ë“œ í…ìŠ¤íŠ¸ / ìŠ¤íƒ€ì¼ =====
  function refreshCard(){
    const nameKo = (nameKoInput.value || 'í…Œì´ì €').trim();
    const nameEn = (nameEnInput.value || 'Taser').trim();
    const rank = rankSelect.value;
    const role = roleSelect.value;

    const roleKor = roleKorMap[role];
    const roleEng = roleEngMap[role];

    cardWrapper.classList.remove(...rankClasses);
    cardWrapper.classList.add('rank-' + rank);

    rankLabel.textContent = rank + ' Rank';
    roleBadge.textContent = roleEng + ' : ' + nameEn.toUpperCase();

    nameKoLabel.textContent = nameKo;
    nameSub.textContent = `${nameEn} Â· ${rank}ê¸‰ ì´ˆëŠ¥ë ¥ ë³´ìœ  ${roleKor}`;

    rolePill.textContent = 'ROLE Â· ' + roleEng;
    dangerPill.textContent = 'DANGER Â· ' + rank;

    emojiSlot1.textContent = (emoji1Input.value || 'ğŸ’¦').trim() || 'ğŸ’¦';
    emojiSlot2.textContent = (emoji2Input.value || 'ğŸ¬').trim() || 'ğŸ¬';
    emojiSlot3.textContent = (emoji3Input.value || 'ğŸ ').trim() || 'ğŸ ';
  }

  nameKoInput.addEventListener('input', refreshCard);
  nameEnInput.addEventListener('input', refreshCard);
  roleSelect.addEventListener('change', refreshCard);
  rankSelect.addEventListener('change', refreshCard);
  emoji1Input.addEventListener('input', refreshCard);
  emoji2Input.addEventListener('input', refreshCard);
  emoji3Input.addEventListener('input', refreshCard);

  // ===== ì´ë¯¸ì§€ í¬ê¸° / ìœ„ì¹˜ ì¡°ì ˆ (IMGìš©) =====
  scaleRange.addEventListener('input', (e) => {
    currentScale = parseFloat(e.target.value);
    updateCharTransform();
  });

  offsetXRange.addEventListener('input', (e) => {
    currentOffsetX = parseFloat(e.target.value);
    updateCharTransform();
  });

  offsetYRange.addEventListener('input', (e) => {
    currentOffsetY = parseFloat(e.target.value);
    updateCharTransform();
  });

  async function downloadJpg() {
    const nameEn = (nameEnInput.value || 'card').trim() || 'card';

    const exportScale = 2;

    const baseCanvas = await html2canvas(cardBorder, {
      backgroundColor: '#ffffff',
      scale: exportScale,
      useCORS: true,
      logging: false,
      imageTimeout: 0
    });

    const paddingX = 20 * exportScale;
    const paddingY = 20 * exportScale;

    const finalCanvas = document.createElement('canvas');
    finalCanvas.width = baseCanvas.width + paddingX * 2;
    finalCanvas.height = baseCanvas.height + paddingY * 2;

    const ctx = finalCanvas.getContext('2d');
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

    ctx.drawImage(baseCanvas, paddingX, paddingY);

    const link = document.createElement('a');
    link.href = finalCanvas.toDataURL('image/png', 1.0);
    link.download = `${nameEn}_card.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  saveJpgBtn.addEventListener('click', () => {
    downloadJpg().catch(console.error);
  });

  // ===== GIF ì €ì¥ (ì›€ì§¤) =====
  async function downloadGif() {
    const nameEn = (nameEnInput.value || 'card').trim() || 'card';

    const rect = cardBorder.getBoundingClientRect();
    const width = Math.round(rect.width * 2);
    const height = Math.round(rect.height * 2);

    const gif = new GIF({
      workers: 2,
      quality: 10,
      width,
      height,
      workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
    });

    const frameCount = 10;
    const frameDelay = 120;

    for (let i = 0; i < frameCount; i++) {
      await new Promise(r => setTimeout(r, frameDelay));
      const canvas = await html2canvas(cardBorder, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true
      });
      gif.addFrame(canvas, { delay: frameDelay, copy: true });
    }

    gif.on('finished', (blob) => {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${nameEn}_card.gif`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    gif.render();
  }

  saveGifBtn.addEventListener('click', () => {
    downloadGif().catch(console.error);
  });

  refreshCard();
</script>
</body>
</html>
